---
title: "BayesDel_github"
author: "Malvika Tejura"
date: "2024-03-12"
output: html_document
---

```{r}

##Run this script to generate analyses for variants that are in trending concordant, trending discordant, or insufficient variants intervals for BayesDel. 

#be sure to add three files to run this script with the correct directory: clinvar_wg = add Supplementary Table 1 file here and clinvar 23 = add Supplementary Table 2 or Table 3 file here depending on whether you want the analysis with or without training variants, VUS = add Supplementary Table 4 file here

#at the very end of the code, please input the file name and directory you want the pdf to save to. The pdf consists of the stacked bar plots from Figure 2 or Figure S1 and donut plots from Figure 5 or Figure S3. 

#load relevant packages
library('dplyr')
library('readxl')
library('ggplot2')
library('tidyverse')
library('ggpubr')
library('cowplot')
library('ggrepel')
library('purrr')
library('ggpattern')

#create dataframes from the data supplemented from the paper 

clinvar_wg = read.csv('ClinGen SVI Calibration Dataset Supplementary Table 1')

#change datatype of BayesDel scores to numeric from clinvar_wg dataframe

clinvar_wg$BayesDel_nsfp33a_noAF = as.numeric(as.character(clinvar_wg$BayesDel_nsfp33a_noAF))

#create dataframes from annotated and parsed csv file 

clinvar23 = read.csv('Clinvar 2023 Dataset Supplementary Table 2 or Clinvar 2023 Dataset without training variants Supplementary Table 3')

#load the VUS file into a dataframe 

VUS = read_csv('Clinvar 2023 Dataset only VUS Supplementary Table 4')

#create a dataframe with only unique genes from the clinvar23 dataframe (used later in code)

clinvar23_unique_Gene = clinvar23 %>% distinct(Gene, .keep_all = TRUE)

#change datatype of REVEL and BayesDel scores form clinvar23 dataframe to numeric

clinvar23$REVEL = as.numeric(as.character(clinvar23$REVEL))
clinvar23$BayesDel_noAF_score = as.numeric(as.character(clinvar23$BayesDel_noAF_score))

#create functions to find percentage of incorrectly predicted variants in each evidence strength interval

#for clivnar_wg dataframe 

path_missclassified = function(df) {
  pathogenic = nrow(filter(df, df$clnsig == 'Pathogenic' | df$clnsig == 'Likely_pathogenic' | df$clnsig == 'Pathogenic/Likely_pathogenic'))
  benign = nrow(filter(df, df$clnsig == 'Benign' | df$clnsig == 'Likely_benign' | df$clnsig == 'Benign/Likely_benign'))
  proportion = benign/(pathogenic + benign)
  return(proportion)
}

ben_missclassified = function(df) {
  pathogenic = nrow(filter(df, df$clnsig == 'Pathogenic' | df$clnsig == 'Likely_pathogenic' | df$clnsig == 'Pathogenic/Likely_pathogenic'))
  benign = nrow(filter(df, df$clnsig == 'Benign' | df$clnsig == 'Likely_benign' | df$clnsig == 'Benign/Likely_benign'))
  proportion = pathogenic/(benign + pathogenic)
  return(proportion)
}

#for clinvar23 dataframe 

path_missclassified_2 = function(df) {
  pathogenic = nrow(filter(df, df$Significance == 'Pathogenic' | df$Significance == 'Likely_pathogenic' | df$Significance == 'Pathogenic/Likely_pathogenic'))
  benign = nrow(filter(df, df$Significance == 'Benign' | df$Significance == 'Likely_benign' | df$Significance == 'Benign/Likely_benign'))
  proportion = benign/(pathogenic + benign)
  return(proportion)
}

ben_missclassified_2 = function(df) {
  pathogenic = nrow(filter(df, df$Significance == 'Pathogenic' | df$Significance == 'Likely_pathogenic' | df$Significance == 'Pathogenic/Likely_pathogenic'))
  benign = nrow(filter(df, df$Significance == 'Benign' | df$Significance == 'Likely_benign' | df$Significance == 'Benign/Likely_benign'))
  proportion = pathogenic/(benign + pathogenic)
  return(proportion)
}

#find the percentage of misclassified variants in each bin from the clinvar_wg dataset for BayesDel. This is the incorrect prediction tolerance. Also calculate the number of variants needed in each interval to be concordant or discordant using the binomial theorem
  
strong_pathogenic_percentage_bd = path_missclassified(filter(clinvar_wg, clinvar_wg$BayesDel_nsfp33a_noAF >= 0.5))
strong_path_x_pass_bd = ceiling(log(0.2)/log(1-strong_pathogenic_percentage_bd))
strong_path_x_fail_bd = ceiling(log(0.2)/log(strong_pathogenic_percentage_bd))

moderate_pathogenic_percentage_bd = path_missclassified(filter(clinvar_wg, clinvar_wg$BayesDel_nsfp33a_noAF < 0.5 & clinvar_wg$BayesDel_nsfp33a_noAF >= 0.27))
moderate_path_x_pass_bd = ceiling(log(0.2)/log(1-moderate_pathogenic_percentage_bd))
moderate_path_x_fail_bd = ceiling(log(0.2)/log(moderate_pathogenic_percentage_bd))

supporting_pathogenic_percentage_bd = path_missclassified(filter(clinvar_wg, clinvar_wg$BayesDel_nsfp33a_noAF < 0.27 & clinvar_wg$BayesDel_nsfp33a_noAF >= 0.13))
supporting_path_x_pass_bd = ceiling(log(0.2)/log(1-supporting_pathogenic_percentage_bd))
supporting_path_x_fail_bd = ceiling(log(0.2)/log(supporting_pathogenic_percentage_bd))

moderate_benign_percentage_bd = ben_missclassified(filter(clinvar_wg, clinvar_wg$BayesDel_nsfp33a_noAF <= -0.36))
moderate_ben_x_pass_bd = ceiling(log(0.2)/log(1-moderate_benign_percentage_bd))
moderate_ben_x_fail_bd = ceiling(log(0.2)/log(moderate_benign_percentage_bd))

supporting_benign_percentage_bd = ben_missclassified(filter(clinvar_wg, clinvar_wg$BayesDel_nsfp33a_noAF > -0.36 & clinvar_wg$BayesDel_nsfp33a_noAF <= -0.18))
supporting_ben_x_pass_bd = ceiling(log(0.2)/log(1-supporting_benign_percentage_bd))
supporting_ben_x_fail_bd = ceiling(log(0.2)/log(supporting_benign_percentage_bd))

#functions to determine if a certain interval in a gene is concordant or discordant depending on the incorrect prediction percentage

pass_fail_path = function(df,bin) {
  p_f = path_missclassified_2(df)
  if (p_f > bin) {
    pass_fail = 'Discordant'
  } else if (p_f <= bin) {
    pass_fail = 'Concordant'
  }
  df$pass_fail = pass_fail
  df$control_variants = nrow(df)
  df$misclassified = nrow(filter(df, df$Significance == 'Benign'| df$Significance == 'Likely_benign' | df$Significance == 'Benign/Likely_benign'))
  return(df)
}

pass_fail_ben = function(df,bin) {
  p_f = ben_missclassified_2(df)
  if (p_f > bin) {
    pass_fail = 'Discordant'
  } else if (p_f <= bin) {
    pass_fail = 'Concordant'
  }
  df$pass_fail = pass_fail
  df$control_variants = nrow(df)
  df$misclassified = nrow(filter(df, df$Significance == 'Pathogenic'| df$Significance == 'Likely_pathogenic' | df$Significance == 'Pathogenic/Likely_pathogenic'))
  return(df)
}

#create dataframes for each evidence strength interval with a pass/fail column depending on the intervals incorrect prediction percentage (pass = incorrect prediction percentage <= incorrect prediction tolerance, fail = incorrect prediction percentage > incorrect prediction tolerance)

strong_pathogenic_bd = filter(clinvar23, clinvar23$BayesDel_noAF_score >= 0.5)
strong_pathogenic_bd = strong_pathogenic_bd %>% group_by(Gene) %>% group_modify(~pass_fail_path(.,strong_pathogenic_percentage_bd))
colnames(strong_pathogenic_bd)[18] = 'pass_fail_strong_pathogenic'
colnames(strong_pathogenic_bd)[19] = 'control_variants_strong_pathogenic'
colnames(strong_pathogenic_bd)[20] = 'misclassified_variants_strong_pathogenic'

#moderate pathogenic
moderate_pathogenic_bd = filter(clinvar23, clinvar23$BayesDel_noAF_score < 0.5 & clinvar23$BayesDel_noAF_score >= 0.27)
moderate_pathogenic_bd = moderate_pathogenic_bd %>% group_by(Gene) %>% group_modify(~pass_fail_path(.,moderate_pathogenic_percentage_bd))
colnames(moderate_pathogenic_bd)[18] = 'pass_fail_moderate_pathogenic'
colnames(moderate_pathogenic_bd)[19] = 'control_variants_moderate_pathogenic'
colnames(moderate_pathogenic_bd)[20] = 'misclassified_variants_moderate_pathogenic'

#supporting pathogenic
supporting_pathogenic_bd = filter(clinvar23, clinvar23$BayesDel_noAF_score < 0.27 & clinvar23$BayesDel_noAF_score >= 0.13)
supporting_pathogenic_bd = supporting_pathogenic_bd %>% group_by(Gene) %>% group_modify(~pass_fail_path(.,supporting_pathogenic_percentage_bd))
colnames(supporting_pathogenic_bd)[18] = 'pass_fail_supporting_pathogenic'
colnames(supporting_pathogenic_bd)[19] = 'control_variants_supporting_pathogenic'
colnames(supporting_pathogenic_bd)[20] = 'misclassified_variants_supporting_pathogenic'

#moderate benign

moderate_benign_bd = filter(clinvar23,clinvar23$BayesDel_noAF_score <= -0.36)
moderate_benign_bd = moderate_benign_bd %>% group_by(Gene) %>% group_modify((~pass_fail_ben(.,moderate_benign_percentage_bd)))
colnames(moderate_benign_bd)[18] = 'pass_fail_moderate_benign'
colnames(moderate_benign_bd)[19] = 'control_variants_moderate_benign'
colnames(moderate_benign_bd)[20] = 'misclassified_variants_moderate_benign'

#supporting benign

supporting_benign_bd = filter(clinvar23, clinvar23$BayesDel_noAF_score > -0.36 & clinvar23$BayesDel_noAF_score <= -0.18)
supporting_benign_bd = supporting_benign_bd %>% group_by(Gene) %>% group_modify((~pass_fail_ben(.,supporting_benign_percentage_bd)))
colnames(supporting_benign_bd)[18] = 'pass_fail_supporting_benign'
colnames(supporting_benign_bd)[19] = 'control_variants_supporting_benign'
colnames(supporting_benign_bd)[20] = 'misclassified_variants_supporting_benign'

#create a new column that annotates whether each variant is in an interval that is concordant,discordant or indeterminate (insufficient evidence). This takes into account how many control variants are in each interval and whether that meets the required number of control variants needed for concordance or discordance. It is also takes into account the incorrect prediction percentage.

strong_pathogenic_bd$pr_variant_pass_strong_path = ifelse(strong_pathogenic_bd$pass_fail_strong_pathogenic == 'Concordant' & strong_pathogenic_bd$control_variants_strong_pathogenic >= strong_path_x_pass_bd, 'Concordant', ifelse(strong_pathogenic_bd$pass_fail_strong_pathogenic == 'Discordant' & strong_pathogenic_bd$control_variants_strong_pathogenic >= strong_path_x_fail_bd,'Discordant','Insufficient variants'))

moderate_pathogenic_bd$pr_variant_pass_moderate_path = ifelse(moderate_pathogenic_bd$pass_fail_moderate_pathogenic == 'Concordant' & moderate_pathogenic_bd$control_variants_moderate_pathogenic >= moderate_path_x_pass_bd, 'Concordant', ifelse(moderate_pathogenic_bd$pass_fail_moderate_pathogenic == 'Discordant' & moderate_pathogenic_bd$control_variants_moderate_pathogenic >= moderate_path_x_fail_bd,'Discordant','Insufficient variants'))

supporting_pathogenic_bd$pr_variant_pass_supporting_path = ifelse(supporting_pathogenic_bd$pass_fail_supporting_pathogenic == 'Concordant' & supporting_pathogenic_bd$control_variants_supporting_pathogenic >= supporting_path_x_pass_bd, 'Concordant', ifelse(supporting_pathogenic_bd$pass_fail_supporting_pathogenic == 'Discordant' & supporting_pathogenic_bd$control_variants_supporting_pathogenic >= supporting_path_x_fail_bd,'Discordant','Insufficient variants'))

supporting_benign_bd$pr_variant_pass_supporting_ben = ifelse(supporting_benign_bd$pass_fail_supporting_benign == 'Concordant' & supporting_benign_bd$control_variants_supporting_benign >= supporting_ben_x_pass_bd, 'Concordant', ifelse(supporting_benign_bd$pass_fail_supporting_benign == 'Discordant' & supporting_benign_bd$control_variants_supporting_benign >= supporting_ben_x_fail_bd,'Discordant','Insufficient variants'))

moderate_benign_bd$pr_variant_pass_moderate_ben = ifelse(moderate_benign_bd$pass_fail_moderate_benign == 'Concordant' & moderate_benign_bd$control_variants_moderate_benign >= moderate_ben_x_pass_bd, 'Concordant', ifelse(moderate_benign_bd$pass_fail_moderate_benign == 'Discordant' & moderate_benign_bd$control_variants_moderate_benign >= moderate_ben_x_fail_bd,'Discordant','Insufficient variants'))

#create dataframes for each interval, keeping only unique genes

strong_pathogenic_unique_bd = strong_pathogenic_bd %>% distinct(Gene, .keep_all = TRUE)
moderate_pathogenic_unique_bd = moderate_pathogenic_bd %>% distinct(Gene, .keep_all = TRUE)
supporting_pathogenic_unique_bd = supporting_pathogenic_bd %>% distinct(Gene, .keep_all = TRUE)

moderate_benign_unique_bd = moderate_benign_bd %>% distinct(Gene, .keep_all = TRUE)
supporting_benign_unique_bd = supporting_benign_bd %>% distinct(Gene, .keep_all = TRUE)

#create a dataframe that has all the gene names/ gene ID's that can be used to merge the different evidence strength interval dataframes, without causing duplicates

clinvar_wg_gene_id_bd = data.frame(Gene = clinvar23_unique_Gene$Gene, Chr = clinvar23_unique_Gene$Chr, GeneID = clinvar23_unique_Gene$GeneID)

#list of dataframes to merge

df_list_bd = list(clinvar_wg_gene_id_bd,strong_pathogenic_unique_bd, moderate_pathogenic_unique_bd, supporting_pathogenic_unique_bd, moderate_benign_unique_bd,supporting_benign_unique_bd)

#final dataframe to create for merge, merge by Gene, GeneID and Chromosome

final_wg_bd = df_list_bd %>% reduce(full_join, by= c('Gene','GeneID','Chr'))

#subset the final dataframe to select for columns needed in downstream analyses

wg_bd = subset(final_wg_bd, select = c(Gene, Chr, GeneID,pass_fail_strong_pathogenic,pass_fail_moderate_pathogenic,pass_fail_supporting_pathogenic,pass_fail_supporting_benign,pass_fail_moderate_benign, control_variants_strong_pathogenic, control_variants_moderate_pathogenic, control_variants_supporting_pathogenic,control_variants_moderate_benign, control_variants_supporting_benign,misclassified_variants_strong_pathogenic, misclassified_variants_moderate_pathogenic, misclassified_variants_supporting_pathogenic,misclassified_variants_moderate_benign, misclassified_variants_supporting_benign,pr_variant_pass_strong_path,pr_variant_pass_moderate_path,pr_variant_pass_supporting_path,pr_variant_pass_moderate_ben, pr_variant_pass_supporting_ben))

# calculate the total number of control variants across the gene in all bins
wg_bd = wg_bd %>%  mutate (total_control_variants = rowSums(select(., control_variants_strong_pathogenic,control_variants_moderate_pathogenic, control_variants_supporting_pathogenic,control_variants_supporting_benign, control_variants_moderate_benign), na.rm = TRUE))

#to make different plots, taking into account all concordance or discordance regardless of control variants

summary_1_bd = data.frame(table(wg_bd$pass_fail_strong_pathogenic))
summary_1_bd$Condition = 'Strong Pathogenic'

summary_2_bd = data.frame(table(wg_bd$pass_fail_moderate_pathogenic))
summary_2_bd$Condition = 'Moderate Pathogenic'

summary_3_bd = data.frame(table(wg_bd$pass_fail_supporting_pathogenic))
summary_3_bd$Condition = 'Supporting Pathogenic'

summary_6_bd = data.frame(table(wg_bd$pass_fail_moderate_benign))
summary_6_bd$Condition = 'Moderate Benign'

summary_7_bd = data.frame(table(wg_bd$pass_fail_supporting_benign))
summary_7_bd$Condition = 'Supporting Benign'

summary_bd = (rbind(summary_1_bd,summary_2_bd,summary_3_bd,summary_6_bd,summary_7_bd))

#Make summary dataframes for plots and take into account intervals that have enough control variants to determine concordance or discordance

strong_pathogenic_pr_bd = filter(wg_bd, wg_bd$control_variants_strong_pathogenic >= strong_path_x_pass_bd)
strong_pathogenic_pr_bd_2 = filter(wg_bd, wg_bd$control_variants_strong_pathogenic >= strong_path_x_fail_bd)
strong_pathogenic_pr_pass_bd = filter(wg_bd, wg_bd$control_variants_strong_pathogenic >= strong_path_x_pass_bd & wg_bd$pass_fail_strong_pathogenic == 'Concordant')
strong_pathogenic_pr_fail_bd = filter(wg_bd, wg_bd$control_variants_strong_pathogenic >= strong_path_x_fail_bd  & wg_bd$pass_fail_strong_pathogenic == 'Discordant')
summary_pr_1_bd = data.frame(c('Concordant','Discordant'),c(nrow(strong_pathogenic_pr_pass_bd), nrow(strong_pathogenic_pr_fail_bd)))
summary_pr_1_bd$Condition = 'Strong Pathogenic'
colnames(summary_pr_1_bd)[1] = 'Var1'
colnames(summary_pr_1_bd)[2] = 'Freq'

moderate_pathogenic_pr_bd = filter(wg_bd, wg_bd$control_variants_moderate_pathogenic >= moderate_path_x_pass_bd)
moderate_pathogenic_pr_bd_2 = filter(wg_bd, wg_bd$control_variants_moderate_pathogenic >= moderate_path_x_fail_bd)
moderate_pathogenic_pr_pass_bd = filter(wg_bd, wg_bd$control_variants_moderate_pathogenic >= moderate_path_x_pass_bd & wg_bd$pass_fail_moderate_pathogenic == 'Concordant')
moderate_pathogenic_pr_fail_bd = filter(wg_bd, wg_bd$control_variants_moderate_pathogenic >= moderate_path_x_fail_bd & wg_bd$pass_fail_moderate_pathogenic == 'Discordant')
summary_pr_2_bd = data.frame(c('Concordant','Discordant'),c(nrow(moderate_pathogenic_pr_pass_bd), nrow(moderate_pathogenic_pr_fail_bd)))
summary_pr_2_bd$Condition = 'Moderate Pathogenic'
colnames(summary_pr_2_bd)[1] = 'Var1'
colnames(summary_pr_2_bd)[2] = 'Freq'

supporting_pathogenic_pr_bd = filter(wg_bd, wg_bd$control_variants_supporting_pathogenic >= supporting_path_x_pass_bd)
supporting_pathogenic_pr_bd_2 = filter(wg_bd, wg_bd$control_variants_supporting_pathogenic >= supporting_path_x_fail_bd)
supporting_pathogenic_pr_pass_bd = filter(wg_bd, wg_bd$control_variants_supporting_pathogenic >= supporting_path_x_pass_bd & wg_bd$pass_fail_supporting_pathogenic == 'Concordant')
supporting_pathogenic_pr_fail_bd = filter(wg_bd, wg_bd$control_variants_supporting_pathogenic >= supporting_path_x_fail_bd & wg_bd$pass_fail_supporting_pathogenic == 'Discordant')
summary_pr_3_bd = data.frame(c('Concordant','Discordant'),c(nrow(supporting_pathogenic_pr_pass_bd), nrow(supporting_pathogenic_pr_fail_bd)))
summary_pr_3_bd$Condition = 'Supporting Pathogenic'
colnames(summary_pr_3_bd)[1] = 'Var1'
colnames(summary_pr_3_bd)[2] = 'Freq'

moderate_benign_pr_bd = filter(wg_bd, wg_bd$control_variants_moderate_benign >= moderate_ben_x_pass_bd)
moderate_benign_pr_bd_2 = filter(wg_bd, wg_bd$control_variants_moderate_benign >= moderate_ben_x_fail_bd)
moderate_benign_pr_pass_bd = filter(wg_bd, wg_bd$control_variants_moderate_benign >= moderate_ben_x_pass_bd & wg_bd$pass_fail_moderate_benign == 'Concordant')
moderate_benign_pr_fail_bd = filter(wg_bd, wg_bd$control_variants_moderate_benign >= moderate_ben_x_fail_bd & wg_bd$pass_fail_moderate_benign == 'Discordant')
summary_pr_6_bd = data.frame(c('Concordant','Discordant'),c(nrow(moderate_benign_pr_pass_bd), nrow(moderate_benign_pr_fail_bd)))
summary_pr_6_bd$Condition = 'Moderate Benign'
colnames(summary_pr_6_bd)[1] = 'Var1'
colnames(summary_pr_6_bd)[2] = 'Freq'


supporting_benign_pr_bd = filter(wg_bd, wg_bd$control_variants_supporting_benign >= supporting_ben_x_pass_bd)
supporting_benign_pr_bd_2 = filter(wg_bd, wg_bd$control_variants_supporting_benign >= supporting_ben_x_fail_bd)
supporting_benign_pr_pass_bd = filter(wg_bd, wg_bd$control_variants_supporting_benign >= supporting_ben_x_pass_bd & wg_bd$pass_fail_supporting_benign == 'Concordant')
supporting_benign_pr_fail_bd = filter(wg_bd, wg_bd$control_variants_supporting_benign >= supporting_ben_x_fail_bd & wg_bd$pass_fail_supporting_benign == 'Discordant')
summary_pr_7_bd = data.frame(c('Concordant','Discordant'),c(nrow(supporting_benign_pr_pass_bd), nrow(supporting_benign_pr_fail_bd)))
summary_pr_7_bd$Condition = 'Supporting Benign'
colnames(summary_pr_7_bd)[1] = 'Var1'
colnames(summary_pr_7_bd)[2] = 'Freq'

#how many genes are there in the clinvar23 dataset
total_genes_bd = length(unique(clinvar23$GeneID))

#rbind the summary datasets together for one big summary dataframe used for the plots  
summary_pr_bd = (rbind(summary_pr_2_bd,summary_pr_1_bd,summary_pr_3_bd,summary_pr_6_bd,summary_pr_7_bd))

#add a new row for variants that are in intdeterminate intervals
new_row_bd = data.frame(Freq = c(sum(summary_1_bd$Freq)- sum(summary_pr_1_bd$Freq), sum(summary_2_bd$Freq)- sum(summary_pr_2_bd$Freq), sum(summary_3_bd$Freq)-sum(summary_pr_3_bd$Freq),sum(summary_6_bd$Freq)- sum(summary_pr_6_bd$Freq),sum(summary_7_bd$Freq)- sum(summary_pr_7_bd$Freq)),Condition = c('Strong Pathogenic','Moderate Pathogenic', 'Supporting Pathogenic','Moderate Benign','Supporting Benign'), Var1 = c('Insufficient variants','Insufficient variants','Insufficient variants','Insufficient variants','Insufficient variants'))

#add a new row for variants that are in intervals with no data (no variants)
new_row_2_bd = data.frame(Freq = c(total_genes_bd- sum(summary_1_bd$Freq), total_genes_bd- sum(summary_2_bd$Freq), total_genes_bd - sum(summary_3_bd$Freq),total_genes_bd-sum(summary_6_bd$Freq),total_genes_bd - sum(summary_7_bd$Freq)), Condition = c('Strong Pathogenic','Moderate Pathogenic', 'Supporting Pathogenic','Moderate Benign','Supporting Benign'), Var1 = c('No Variants','No Variants','No Variants','No Variants','No Variants'))

#rbind the two new rows to the summary dataframe
summary_pr_bd = rbind(summary_pr_bd, new_row_bd, new_row_2_bd)

#factor the condition for the summary data according to how you want the conditions displayed on the plots
summary_pr_bd$Condition = factor(summary_pr_bd$Condition, levels = c('Moderate Benign','Supporting Benign','Supporting Pathogenic','Moderate Pathogenic','Strong Pathogenic'))

#create a new dataframe for use later for the VUS donut plots
wg_variant_donut_bd = rbind(strong_pathogenic_bd, moderate_pathogenic_bd, supporting_pathogenic_bd, moderate_benign_bd, supporting_benign_bd)

#stacked barplot Figure 2 panel A
plot_1_bd = ggplot(summary_pr_bd, aes(fill = Var1, x = Condition, y = Freq), pattern = Var1) + geom_bar_pattern(aes(fill = Var1, pattern = Var1),stat = 'identity',position = position_stack(),
                   pattern_fill = c('No Variants' ="black"),
                   pattern_angle = 45,
                   pattern_density = 0.05,
                   pattern_spacing = 0.025,
                   pattern_key_scale_factor = 0.6) + theme_classic(base_size = 14) + theme(plot.title = element_text (size = 12,hjust = 0.5),axis.text.x = element_text(angle = 30, vjust = 1, hjust=1))+ geom_label_repel(mapping = aes(fill = Var1, label = Freq), direction = 'y',color = 'white',position = position_stack(reverse = FALSE, vjust = 0.5),size = 4, fontface = "bold", show.legend = FALSE,min.segment.length = unit(6, 'lines'), force = 0.0025, force_pull = 0, box.padding = 0.5, point.size = NA) + guides(fill=guide_legend(title="Legend_bd"))+ scale_fill_manual(name = 'Legend_bd',values = c('Concordant' = '#AEAE00', 'Discordant' = '#E8A11C','Insufficient variants' = '#695B73', 'No Variants' = '#695B73')) + scale_pattern_manual(name = 'Legend_bd', values = c('No Variants' = 'stripe', 'Concordant' = 'none', 'Discordant' = 'none', 'Insufficient variants' = 'none')) + labs(x = NULL, y = 'Number of Genes', title = str_wrap('BayesDel stacked barplot : concordance, discordance, or insufficient variants by evidence strength intervals')) 

plot_1_bd

#load acmg genes names into a list

ACMG_genes = c('ACTA2',
'ACTC1',
'ACVRL1',
'APC',
'APOB',
'ATP7B',
'BAG3',
'BMPR1A',
'BRCA1',
'BRCA2',
'BTD',
'CACNA1S',
'CASQ2',
'COL3A1',
'DES',
'DSG2',
'DSC2',
'DSP',
'ENG',
'FBN1',
'FLNC',
'GAA',
'GLA',
'HFE',
'HNF1A',
'KCNH2',
'KCNQ1',
'LDLR',
'LMNA',
'MAX',
'MEN1',
'MLH1',
'MSH2',
'MSH6',
'MUTYH',
'MYBPC3',
'MYH11',
'MYH7',
'MYL2',
'MYL3',
'NF2',
'OTC',
'PALB2',
'PCSK9',
'PKP2',
'PMS2',
'PRKAG2',
'PTEN',
'RB1',
'RBM20',
'RET',
'RPE65',
'RYR1',
'RYR2',
'SCN5A',
'SDHAF2',
'SDHB',
'SDHC',
'SDHD',
'SMAD3',
'SMAD4',
'STK11',
'TGFBR1',
'TGFBR2',
'TMEM127',
'TMEM43',
'TNNC1',
'TNNI3',
'TNNT2',
'TP53',
'TPM1',
'TRDN',
'TSC1',
'TSC2',
'TTN',
'TTR',
'VHL',
'WT1')

#filter the whole genome dataframe on only acmg genes

wg_acmg_x_bd = wg_bd %>%
  filter(map_lgl(Gene, ~ any(ACMG_genes %in% .x)))

#count which genes intervals are in concordant, discordant or insufficient variants intervals for ACMG genes

wg_acmg_pr_bd = data.frame(Var1 = c('Concordant','Discordant','Insufficient variants','No Variants','Concordant','Discordant','Insufficient variants','No Variants','Concordant','Discordant','Insufficient variants','No Variants','Concordant','Discordant','Insufficient variants','No Variants','Concordant','Discordant','Insufficient variants','No Variants'), Freq = c(nrow(filter(wg_acmg_x_bd,wg_acmg_x_bd$pr_variant_pass_strong_path == 'Concordant')), nrow(filter(wg_acmg_x_bd,wg_acmg_x_bd$pr_variant_pass_strong_path == 'Discordant')),nrow(filter(wg_acmg_x_bd,wg_acmg_x_bd$pr_variant_pass_strong_path == 'Insufficient variants')),nrow(filter(wg_acmg_x_bd,is.na(wg_acmg_x_bd$pr_variant_pass_strong_path) == TRUE)),nrow(filter(wg_acmg_x_bd,wg_acmg_x_bd$pr_variant_pass_moderate_path == 'Concordant')), nrow(filter(wg_acmg_x_bd,wg_acmg_x_bd$pr_variant_pass_moderate_path == 'Discordant')),nrow(filter(wg_acmg_x_bd,wg_acmg_x_bd$pr_variant_pass_moderate_path == 'Insufficient variants')),nrow(filter(wg_acmg_x_bd,is.na(wg_acmg_x_bd$pr_variant_pass_moderate_path) == TRUE)),nrow(filter(wg_acmg_x_bd,wg_acmg_x_bd$pr_variant_pass_supporting_path == 'Concordant')), nrow(filter(wg_acmg_x_bd,wg_acmg_x_bd$pr_variant_pass_supporting_path == 'Discordant')),nrow(filter(wg_acmg_x_bd,wg_acmg_x_bd$pr_variant_pass_supporting_path == 'Insufficient variants')),nrow(filter(wg_acmg_x_bd,is.na(wg_acmg_x_bd$pr_variant_pass_supporting_path) == TRUE)),nrow(filter(wg_acmg_x_bd,wg_acmg_x_bd$pr_variant_pass_moderate_ben == 'Concordant')), nrow(filter(wg_acmg_x_bd,wg_acmg_x_bd$pr_variant_pass_moderate_ben == 'Discordant')),nrow(filter(wg_acmg_x_bd,wg_acmg_x_bd$pr_variant_pass_moderate_ben == 'Insufficient variants')),nrow(filter(wg_acmg_x_bd,is.na(wg_acmg_x_bd$pr_variant_pass_moderate_ben) == TRUE)),nrow(filter(wg_acmg_x_bd,wg_acmg_x_bd$pr_variant_pass_supporting_ben == 'Concordant')), nrow(filter(wg_acmg_x_bd,wg_acmg_x_bd$pr_variant_pass_supporting_ben == 'Discordant')),nrow(filter(wg_acmg_x_bd,wg_acmg_x_bd$pr_variant_pass_supporting_ben == 'Insufficient variants')),nrow(filter(wg_acmg_x_bd,is.na(wg_acmg_x_bd$pr_variant_pass_supporting_ben) == TRUE))), Condition = c('Strong Pathogenic', 'Strong Pathogenic', 'Strong Pathogenic','Strong Pathogenic', 'Moderate Pathogenic','Moderate Pathogenic','Moderate Pathogenic','Moderate Pathogenic','Supporting Pathogenic','Supporting Pathogenic','Supporting Pathogenic','Supporting Pathogenic','Moderate Benign','Moderate Benign','Moderate Benign','Moderate Benign','Supporting Benign','Supporting Benign','Supporting Benign','Supporting Benign'))

#Condition acmg stacked barplot 
wg_acmg_pr_bd$Condition = factor(wg_acmg_pr_bd$Condition, levels = c('Moderate Benign','Supporting Benign','Supporting Pathogenic','Moderate Pathogenic','Strong Pathogenic'))


#acmg stacked barplot, Figure 2 panel C
plot_2_bd = ggplot(wg_acmg_pr_bd, aes(fill = Var1, x = Condition, y = Freq), pattern = Var1) + geom_bar_pattern(aes(fill = Var1, pattern = Var1),stat = 'identity',position = position_stack(),
                   pattern_fill = c('No Variants' ="black"),
                   pattern_angle = 45,
                   pattern_density = 0.05,
                   pattern_spacing = 0.025,
                   pattern_key_scale_factor = 0.6) + theme_classic(base_size = 14) + theme(plot.title = element_text (size = 12,hjust = 0.5),axis.text.x = element_text(angle = 30, vjust = 1, hjust=1))+ geom_label_repel(mapping = aes(fill = Var1, label = Freq), direction = 'y',color = 'white',position = position_stack(reverse = FALSE, vjust = 0.5),size = 4, fontface = "bold", show.legend = FALSE,min.segment.length = unit(6, 'lines'), force = 0.0025, force_pull = 0, box.padding = 0.5, point.size = NA) + guides(fill=guide_legend(title="Legend_bd"))+ scale_fill_manual(name = 'Legend_bd',values = c('Concordant' = '#AEAE00', 'Discordant' = '#E8A11C','Insufficient variants' = '#695B73', 'No Variants' = '#695B73')) + scale_pattern_manual(name = 'Legend_bd', values = c('No Variants' = 'stripe', 'Concordant' = 'none', 'Discordant' = 'none', 'Insufficient variants' = 'none')) + labs(x = NULL, y = 'Number of Genes', title = str_wrap('BayesDel stacked barplot : concordance, discordance, or insufficient variants by evidence strength intervals')) 

plot_2_bd

#function to count the number of variants in each evidence strength interval

interval_num_variants_bd = function(df) {
  df$str_path_VUS_num = nrow(filter(df, df$BayesDel_noAF_score >= 0.5))
  df$mod_path_VUS_num = nrow(filter(df, df$BayesDel_noAF_score < 0.5 & df$BayesDel_noAF_score >= 0.27))
  df$supp_path_VUS_num = nrow(filter(df, df$BayesDel_noAF_score < 0.27 & df$BayesDel_noAF_score >= 0.13))
  df$supp_ben_VUS_num = nrow(filter(df, df$BayesDel_noAF_score > -0.36 & df$BayesDel_noAF_score <= -0.18))
  df$mod_ben_VUS_num = nrow(filter(df, df$BayesDel_noAF_score <= -0.36))
  return(df)                              
}

#count the number of VUS in each interval for each gene
wg_bd_VUS = VUS %>% group_by(Gene) %>% group_modify(~interval_num_variants_bd(.))

#keep distinct genes
wg_bd_VUS = wg_bd_VUS %>% distinct(Gene, .keep_all = TRUE)

#merge wg and wg_VUS dataframes on gene to get the count of VUS in each interval
VUS_merge_bd = merge(wg_bd,wg_bd_VUS, by = 'Gene', all.x = TRUE, all.y = FALSE)

#subset the merged dataframe
VUS_merge_x_bd = subset(VUS_merge_bd, select = c(Chr.x, Start, End, Ref, Alt, REVEL, BayesDel_noAF_score, genome_AF, exome_AF, Otherinfo11, Stars, GeneID.x,Significance, clnvc, Variant_type, Gene,pr_variant_pass_strong_path,pr_variant_pass_moderate_path,pr_variant_pass_supporting_path,pr_variant_pass_moderate_ben,pr_variant_pass_supporting_ben,str_path_VUS_num,mod_path_VUS_num,supp_path_VUS_num,supp_ben_VUS_num,mod_ben_VUS_num))

#function to count the number of variants in Concordant, discordant or insufficient variants intervals

calc_bd <- function(df) {
  df <- df %>%
    mutate(
      concordant_1 = if_else(pr_variant_pass_strong_path == 'Concordant', str_path_VUS_num, 0),
      concordant_2 = if_else(pr_variant_pass_moderate_path == 'Concordant', mod_path_VUS_num, 0),
      concordant_3 = if_else(pr_variant_pass_supporting_path == 'Concordant', supp_path_VUS_num, 0),
      concordant_4 = if_else(pr_variant_pass_supporting_ben == 'Concordant', supp_ben_VUS_num, 0),
      concordant_5 = if_else(pr_variant_pass_moderate_ben == 'Concordant', mod_ben_VUS_num, 0),
      
      Discordant_1 = if_else(df$pr_variant_pass_strong_path == 'Discordant', df$str_path_VUS_num, 0),
      Discordant_2 = if_else(df$pr_variant_pass_moderate_path == 'Discordant', df$mod_path_VUS_num, 0),
      Discordant_3 = if_else(df$pr_variant_pass_supporting_path == 'Discordant', df$supp_path_VUS_num,0),
      Discordant_4 = if_else(df$pr_variant_pass_supporting_ben == 'Discordant', df$supp_ben_VUS_num, 0),
      Discordant_5 = if_else(df$pr_variant_pass_moderate_ben == 'Discordant', df$mod_ben_VUS_num, 0),
      
      Insufficient_variants_1 = if_else(df$pr_variant_pass_strong_path == 'Insufficient variants', df$str_path_VUS_num, 0),
    Insufficient_variants_2 = if_else(df$pr_variant_pass_moderate_path == 'Insufficient variants', df$mod_path_VUS_num, 0),
    Insufficient_variants_3 = if_else(df$pr_variant_pass_supporting_path == 'Insufficient variants', df$supp_path_VUS_num,0),
    Insufficient_variants_4 = if_else(df$pr_variant_pass_supporting_ben == 'Insufficient variants', df$supp_ben_VUS_num, 0),
    Insufficient_variants_5 = if_else(df$pr_variant_pass_moderate_ben == 'Insufficient variants', df$mod_ben_VUS_num, 0),
    )
  
  return(df)
}

cc_bd = VUS_merge_x_bd %>% mutate(calc_bd(.))

cc_bd$Concordant <- rowSums(cc_bd[, c("concordant_1", "concordant_2", "concordant_3", "concordant_4", "concordant_5")], na.rm = TRUE)

cc_bd$Discordant <- rowSums(cc_bd[, c("Discordant_1", "Discordant_2", "Discordant_3", "Discordant_4", "Discordant_5")], na.rm = TRUE)

cc_bd$Insufficient_variants <- rowSums(cc_bd[, c("Insufficient_variants_1", "Insufficient_variants_2", "Insufficient_variants_3", "Insufficient_variants_4", "Insufficient_variants_5")], na.rm = TRUE)

#donut plot variant priors

data_bd = data.frame(
  Significance = c('Concordant','Discordant','Insufficient variants'),
  count = c(sum(cc_bd$Concordant),sum(cc_bd$Discordant),sum(cc_bd$Insufficient_variants)))

data_bd$Significance = factor(data_bd$Significance, levels = c('Concordant','Discordant','Insufficient variants'))

print(sum(data_bd$count))

# Compute percentages
data_bd$fraction = data_bd$count / sum(data_bd$count)

data_bd$ymax = cumsum(data_bd$fraction)

# Compute the bottom of each rectangle
data_bd$ymin = c(0, head(data_bd$ymax, n=-1))

# Compute label position
data_bd$labelPosition <- (data_bd$ymax + data_bd$ymin) / 2

# Compute a good label
data_bd$label <- paste0(data_bd$Significance, "\n value: ", data_bd$count)

# Make the plot
plot_3_bd = ggplot(data_bd, aes(ymax=ymax, ymin=ymin, xmax=7, xmin=6, fill=Significance)) +
  geom_rect() +
  geom_label( x= 6, aes(y=labelPosition, label=label), size=4.5) + scale_fill_manual(values = c('Discordant' = '#E8A11C','Concordant' = '#AEAE00','Insufficient variants' = '#695B73')) +
  coord_polar(theta="y") +
  xlim(c(3, 7)) +
  theme_void() +
  theme(legend.position = "none", plot.title = element_text (size = 12,hjust = 0.5)) + ggtitle('VUS that fall into concordant, discordant, or insufficient variants intervals, disease relevant genes')

plot_3_bd

#save all three plots to a pdf, insert file name you want

pdf(file = 'file_name_here', width = 8, height = 8)

plot_1_bd

plot_2_bd

plot_3_bd

dev.off()


```